{% load static %}

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Станция Юных Техников{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
</head>
<body>
    {% block page_header %}{% endblock %}
    <nav>
        <ul>
            <li><a href="{% url 'core:home' %}">Главная</a></li>
            <li>
                <a href="#">О нас</a>
                <ul>
                    <li><a href="{% url 'pages:history' %}">История</a></li>
                    <li><a href="{% url 'programs:teacher_list' %}">Наша команда</a></li>
                    <li><a href="{% url 'core:achievement_list' %}">Достижения</a></li>
                    <li><a href="{% url 'gallery:album_list' %}">Фотогалерея</a></li>
                    <li><a href="{% url 'pages:official_info' %}">Официальные сведения</a></li>
                </ul>
            </li>
            <li><a href="{% url 'programs:list' %}">Направления</a></li>
            <li>
                <a href="#">События</a>
                <ul>
                    <li><a href="{% url 'news:list' %}">Новости</a></li>
                    <li><a href="{% url 'news:contest_list' %}">Конкурсы</a></li>
                    <li><a href="{% url 'notice:list' %}">Объявления</a></li>
                </ul>
            </li>
            <li><a href="{% url 'schedule:list' %}">Расписание</a></li>
            <li><a href="{% url 'pages:summer_camp' %}">Летний лагерь</a></li>
            <li><a href="{% url 'pages:safety' %}">Безопасность</a></li>
            <li><a href="{% url 'pages:contacts' %}">Контакты</a></li>
        </ul>
    </nav>

    <main>
        {% block content %}
        {% endblock %}
    </main>

    <!-- Chat Widget -->
    <div class="chat-widget-container">
        <div id="chat-window" class="chat-window">
            <div class="chat-header">
                <h5>Помощник</h5>
                <button id="close-chat-btn" class="btn-close"></button>
            </div>
            <div id="chat-messages" class="chat-messages">
                <!-- Messages will be appended here -->
            </div>
            <div class="chat-input">
                <form id="chat-form">
                    <input type="text" id="chat-message-input" class="form-control" placeholder="Спросите что-нибудь...">
                    <button type="submit" class="btn btn-primary">Отправить</button>
                </form>
            </div>
        </div>
        <button id="open-chat-btn" class="chat-open-btn">
            <img src="{% static 'img/chat_icon.svg' %}" alt="Chat">
        </button>
    </div>

    <footer>
        <p>&copy; {% now "Y" %} Станция Юных Техников. Все права защищены.</p>
        <div class="social-links">
            <a href="https://vk.com/sut39" target="_blank"><img src="{% static 'img/vk_icon.svg' %}" alt="VK"></a>
            <a href="https://t.me/your_telegram_channel" target="_blank"><img src="{% static 'img/telegram_icon.svg' %}" alt="Telegram"></a>
            <a href="https://max.ru/" target="_blank"><img src="{% static 'img/max_icon.svg' %}" alt="MAX"></a>
        </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="{% static 'js/main.js' %}" defer></script>
    <!-- Chat Widget Script -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const openChatBtn = document.getElementById('open-chat-btn');
        const closeChatBtn = document.getElementById('close-chat-btn');
        const chatWindow = document.getElementById('chat-window');
        const chatMessages = document.getElementById('chat-messages');
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('chat-message-input');

        let session_id = sessionStorage.getItem('chat_session_id');

        function addMessage(sender, text) {
            const messageEl = document.createElement('div');
            messageEl.classList.add('message', `message-${sender}`);
            messageEl.textContent = text;
            chatMessages.appendChild(messageEl);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        openChatBtn.addEventListener('click', () => {
            chatWindow.classList.add('open');
            openChatBtn.style.display = 'none';

            // Add initial bot message if not already shown for this session
            if (!sessionStorage.getItem('welcome_message_shown')) {
                addMessage('bot', 'Здравствуй, друг!\nСпрашивай обо всем, что касается СЮТ. Я постараюсь помочь.');
                sessionStorage.setItem('welcome_message_shown', 'true');
            }
        });

        closeChatBtn.addEventListener('click', () => {
            chatWindow.classList.remove('open');
            openChatBtn.style.display = 'flex';
        });

        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const userMessage = messageInput.value.trim();
            if (!userMessage) return;

            addMessage('user', userMessage);
            messageInput.value = '';

            fetch("{% url 'ai_chat:chat_api' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: userMessage,
                    session_id: session_id
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    addMessage('bot', `Ошибка: ${data.error}`);
                } else {
                    addMessage('bot', data.response);
                    if (data.session_id) {
                        session_id = data.session_id;
                        sessionStorage.setItem('chat_session_id', session_id);
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                addMessage('bot', 'Извините, произошла ошибка. Попробуйте позже.');
            });
        });
    });
    </script>